<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏á‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</title>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        header {
            background-color: #4a90e2;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        #setup-section {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #chat-section {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: bold;
            color: #333;
        }

        input[type="text"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        button {
            padding: 10px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #357abd;
        }

        #chat-history {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #e5ddd5;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 10px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .user-message {
            align-self: flex-end;
            background-color: #dcf8c6;
            color: #000;
            border-bottom-right-radius: 2px;
        }

        .ai-message {
            align-self: flex-start;
            background-color: #fff;
            color: #000;
            border-bottom-left-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .input-area {
            padding: 10px;
            background-color: #f0f0f0;
            display: flex;
            gap: 10px;
            border-top: 1px solid #ddd;
        }

        #user-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .loading {
            align-self: center;
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }
        
        /* Markdown style basic support */
        .ai-message p { margin: 0 0 10px 0; }
        .ai-message p:last-child { margin-bottom: 0; }
        .ai-message strong { font-weight: bold; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <!-- Import Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<div class="container">
    <header>AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏á‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</header>

    <div id="setup-section">
        <div class="form-group">
            <label for="novel-title">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
            <input type="text" id="novel-title" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...">
        </div>
        <div class="form-group">
            <label for="novel-genre">‡πÅ‡∏ô‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
            <input type="text" id="novel-genre" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ü‡∏ô‡∏ï‡∏≤‡∏ã‡∏µ, ‡∏£‡∏±‡∏Å‡πÇ‡∏£‡πÅ‡∏°‡∏ô‡∏ï‡∏¥‡∏Å, ‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô...">
        </div>
        <div class="form-group">
            <label for="writing-style">‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</label>
            <select id="writing-style" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                <option value="literary">‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏ó‡∏û (‡∏ß‡∏£‡∏£‡∏ì‡∏Å‡∏£‡∏£‡∏°/‡∏™‡∏•‡∏∞‡∏™‡∏•‡∏ß‡∏¢)</option>
                <option value="teen">‡∏†‡∏≤‡∏©‡∏≤‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô (‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢/‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="name-era">‡∏¢‡∏∏‡∏Ñ‡∏™‡∏°‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</label>
            <select id="name-era" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                <option value="ancient">‡πÄ‡∏Å‡πà‡∏≤ (‡πÇ‡∏ö‡∏£‡∏≤‡∏ì/‡∏¢‡πâ‡∏≠‡∏ô‡∏¢‡∏∏‡∏Ñ/‡∏û‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏î)</option>
                <option value="classic">‡∏Å‡∏•‡∏≤‡∏á (‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Å/‡∏£‡πà‡∏ß‡∏°‡∏™‡∏°‡∏±‡∏¢)</option>
                <option value="modern">‡πÉ‡∏´‡∏°‡πà (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô/‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á)</option>
                <option value="greek">‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô (‡∏Å‡∏£‡∏µ‡∏Å/‡πÇ‡∏£‡∏°‡∏±‡∏ô/‡πÄ‡∏ó‡∏û‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢)</option>
                <option value="chinese">‡∏à‡∏µ‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô/‡πÄ‡∏ó‡∏û‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô)</option>
                <option value="japanese">‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô (‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞/‡∏°‡∏±‡∏á‡∏á‡∏∞)</option>
                <option value="future">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï/‡πÅ‡∏ü‡∏ô‡∏ï‡∏≤‡∏ã‡∏µ/‡∏•‡πâ‡∏≥‡∏¢‡∏∏‡∏Ñ)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="total-chapters">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≠‡∏ô (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)</label>
            <input type="number" id="total-chapters" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5, 10 (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ)" min="1">
        </div>
        <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
            <input type="checkbox" id="story-only-mode" checked style="width: auto; margin: 0;">
            <label for="story-only-mode" style="font-weight: normal; cursor: pointer;">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏•‡πâ‡∏ß‡∏ô (‡πÑ‡∏°‡πà‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏•‡πà‡∏ô/‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏£‡∏¥‡πà‡∏ô‡∏ô‡∏≥)</label>
        </div>
        <button onclick="startChat()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</button>
    </div>

    <div id="chat-section">
        <div class="chat-header-controls" style="padding: 10px; background-color: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; gap: 10px;">
            <div id="chapter-status" style="font-weight: bold; color: #4a90e2;"></div>
            <div style="display: flex; gap: 5px;">
                <button onclick="exportChat()" style="background-color: #28a745; padding: 5px 10px; font-size: 0.9rem;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button onclick="resetChat()" style="background-color: #dc3545; padding: 5px 10px; font-size: 0.9rem;">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>
        <div id="chat-history"></div>
        <div class="loading" id="loading-indicator">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå...</div>
        <div class="input-area">
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <button onclick="continueStory()" style="background-color: #ffc107; color: #333; font-weight: bold; font-size: 0.8rem;">‚è© ‡πÅ‡∏ï‡πà‡∏á‡∏ï‡πà‡∏≠ (‡∏â‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°)</button>
                <button onclick="nextChapter()" id="next-chapter-btn" style="background-color: #17a2b8; color: white; font-weight: bold; font-size: 0.8rem;">‚è≠Ô∏è ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            <input type="text" id="user-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()">‡∏™‡πà‡∏á</button>
        </div>
    </div>
</div>

<script>
    // Configuration
    // API Call is now handled by the backend server to secure the key
    // const API_KEY = 'AIzaSyDUvr5l01Va5p3pr8jvEK3_0aRT1EYUaGs'; // REMOVED
    // const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`; // REMOVED

    let chatHistory = [];
    let novelTitle = "";
    let novelGenre = "";
    let writingStyle = "literary";
    let nameEra = "modern";
    let isStoryOnlyMode = true;
    let totalChapters = 0;
    let currentChapter = 1;

    function startChat() {
        novelTitle = document.getElementById('novel-title').value.trim();
        novelGenre = document.getElementById('novel-genre').value.trim();
        writingStyle = document.getElementById('writing-style').value;
        nameEra = document.getElementById('name-era').value;
        const totalChaptersInput = document.getElementById('total-chapters').value;
        totalChapters = totalChaptersInput ? parseInt(totalChaptersInput) : 0;
        isStoryOnlyMode = document.getElementById('story-only-mode').checked;
        currentChapter = 1;

        if (!novelTitle || !novelGenre) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
            return;
        }

        document.getElementById('setup-section').style.display = 'none';
        document.getElementById('chat-section').style.display = 'flex';
        updateChapterDisplay();

        // Initial system prompt setup
        let initialPrompt = "";
        let lengthInstruction = "";

        if (totalChapters > 0) {
            lengthInstruction = `4. **‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á:** ‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${totalChapters} ‡∏ï‡∏≠‡∏ô
   - ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ **‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1**
   - ‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏î‡πÄ‡∏¢‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏´‡πâ‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ`;
        } else {
            lengthInstruction = `4. **‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á:** ‡πÅ‡∏ï‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏à‡∏ö`;
        }
        
        let styleInstruction = "";
        if (writingStyle === 'literary') {
            styleInstruction = `2. **‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Masterpiece Level Thai Writing):**
   - ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ß‡∏£‡∏£‡∏ì‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏∞‡∏™‡∏•‡∏ß‡∏¢ ‡∏á‡∏î‡∏á‡∏≤‡∏° ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ì‡∏µ‡∏ï (‡∏£‡∏≤‡∏ß‡∏Å‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ã‡∏µ‡πÑ‡∏£‡∏ï‡πå)
   - ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (Vivid Imagery) ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏ó‡∏±‡πâ‡∏á 5 (‡∏£‡∏π‡∏õ, ‡∏£‡∏™, ‡∏Å‡∏•‡∏¥‡πà‡∏ô, ‡πÄ‡∏™‡∏µ‡∏¢‡∏á, ‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™)
   - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (Word Choice) ‡∏ó‡∏µ‡πà‡∏Ñ‡∏°‡∏Ñ‡∏≤‡∏¢ ‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏≤‡∏Å‡∏•‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ã‡πâ‡∏≥‡∏ã‡∏≤‡∏Å
   - ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏õ‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏µ‡∏•‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏ó‡πâ‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏û‡πÄ‡∏£‡∏≤‡∏∞
   - ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏à‡∏∞‡πÇ‡∏Ñ‡∏ô (Pacing) ‡∏ó‡∏µ‡πà‡∏î‡∏µ ‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡πâ‡∏≠‡∏¢‡∏ï‡∏≤‡∏°`;
        } else {
            styleInstruction = `2. **‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô‡∏¢‡∏∏‡∏Ñ‡πÉ‡∏´‡∏°‡πà (Modern Teen Vibe):**
   - ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô Gen Z ‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢ ‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏á‡πà‡∏≤‡∏¢
   - ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏±‡∏ô‡∏™‡πå‡πÜ
   - ‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ (Dialogue) ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏• ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡πÅ‡∏•‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏∂‡πâ‡∏á, ‡∏ï‡∏∂‡∏á, ‡∏ö‡∏π‡∏î, ‡πÄ‡∏ü‡∏µ‡∏¢‡∏£‡πå‡∏™, ‡∏â‡πà‡∏≥ ‡∏Ø‡∏•‡∏Ø) ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
   - ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ß ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏î‡πÄ‡∏¢‡∏≤‡∏î ‡∏ô‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
   - ‡πÉ‡∏™‡πà‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (Emotional & Relatable)`;
        }

        let nameInstruction = "";
        switch (nameEra) {
            case 'ancient':
                nameInstruction = "5. **‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç):** ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö **‡πÇ‡∏ö‡∏£‡∏≤‡∏ì/‡∏¢‡πâ‡∏≠‡∏ô‡∏¢‡∏∏‡∏Ñ/‡∏û‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏î** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏°‡πà‡∏´‡∏ç‡∏¥‡∏á‡∏Å‡∏≤‡∏£‡∏∞‡πÄ‡∏Å‡∏î, ‡∏Ç‡∏∏‡∏ô‡πÄ‡∏î‡∏ä, ‡∏ó‡∏≠‡∏á‡∏Å‡∏ß‡∏≤‡∏ß, ‡∏´‡∏•‡∏ß‡∏á‡πÄ‡∏ó‡∏û) ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î";
                break;
            case 'classic':
                nameInstruction = "5. **‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç):** ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö **‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Å/‡∏£‡πà‡∏ß‡∏°‡∏™‡∏°‡∏±‡∏¢** ‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏î‡∏π‡πÑ‡∏û‡πÄ‡∏£‡∏≤‡∏∞ ‡∏™‡∏∏‡∏†‡∏≤‡∏û (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏≤‡∏ô‡∏ô‡∏ó‡πå, ‡∏£‡∏¥‡∏ô‡∏•‡∏î‡∏≤, ‡∏Å‡πâ‡∏≠‡∏á‡∏†‡∏û, ‡∏°‡∏ì‡∏µ) ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ";
                break;
            case 'modern':
                nameInstruction = "5. **‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç):** ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö **‡∏Ñ‡∏ô‡∏¢‡∏∏‡∏Ñ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (2024+)** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô! ‡πÄ‡∏ô‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô/‡∏Ñ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏¢‡∏∏‡∏Ñ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏µ‡∏°, ‡∏û‡∏•‡∏≠‡∏¢, ‡∏ô‡∏ô‡∏ó‡πå, ‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏™, ‡πÄ‡∏Å‡∏£‡∏ã, ‡∏°‡∏¥‡∏Å‡∏ã‡πå) ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏¢‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ö‡∏£‡∏≤‡∏ì";
                break;
            case 'greek':
                nameInstruction = "5. **‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç):** ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö **‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡∏Å‡∏£‡∏µ‡∏Å/‡πÇ‡∏£‡∏°‡∏±‡∏ô/‡πÄ‡∏ó‡∏û‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å** (‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∏‡∏™, ‡∏≠‡∏û‡∏≠‡∏•‡πÇ‡∏•, ‡πÄ‡∏Æ‡πÄ‡∏•‡∏ô, ‡∏≠‡∏Ñ‡∏¥‡∏•‡∏•‡∏µ‡∏™, ‡πÑ‡∏î‡∏≠‡∏≤‡∏ô‡πà‡∏≤, ‡πÅ‡∏≠‡∏ï‡∏•‡∏≤‡∏™) ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ò‡∏µ‡∏°‡πÄ‡∏ó‡∏û‡∏õ‡∏Å‡∏£‡∏ì‡∏±‡∏°";
                break;
            case 'chinese':
                nameInstruction = "5. **‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç):** ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö **‡∏à‡∏µ‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô/‡πÄ‡∏ó‡∏û‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô)** (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏•‡∏µ‡πà‡∏°‡∏π‡πà‡πÑ‡∏õ‡πã, ‡∏à‡∏≤‡∏á‡πÄ‡∏´‡∏ß‡πà‡∏¢, ‡πÄ‡∏ã‡∏µ‡∏¢‡∏ß‡πÄ‡∏´‡∏•‡∏ô, ‡πÄ‡∏ü‡∏¢‡∏´‡∏á, ‡πÑ‡∏õ‡πã‡∏´‡∏•‡∏á) ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡∏¢‡∏∏‡∏ó‡∏ò‡∏†‡∏û";
                break;
            case 'japanese':
                nameInstruction = "5. **‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç):** ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö **‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô (‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞/‡∏°‡∏±‡∏á‡∏á‡∏∞)** (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏≤‡∏ô‡∏≤‡∏Å‡∏∞, ‡∏ã‡∏≤‡∏Å‡∏∏‡∏£‡∏∞, ‡πÄ‡∏£‡πá‡∏ô, ‡∏¢‡∏π‡∏°‡∏¥, ‡∏Æ‡∏¥‡πÇ‡∏£‡∏ä‡∏¥, ‡∏Ñ‡∏≤‡∏ã‡∏∂‡∏¢‡∏∞) ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ü‡∏µ‡∏•‡∏•‡∏¥‡πà‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô";
                break;
            case 'future':
                nameInstruction = "5. **‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç):** ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö **‡∏•‡πâ‡∏≥‡∏¢‡∏∏‡∏Ñ/‡πÅ‡∏ü‡∏ô‡∏ï‡∏≤‡∏ã‡∏µ/‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå** ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÅ‡∏õ‡∏•‡∏Å‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ã‡∏ô, ‡πÑ‡∏≠‡∏£‡πà‡∏≤, ‡∏ô‡∏µ‡πÇ‡∏≠, ‡∏ã‡∏µ‡πÇ‡∏ô‡πà, ‡∏•‡∏π‡∏ô‡∏≤) ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏û‡∏ö‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô";
                break;
        }

        if (isStoryOnlyMode) {
            initialPrompt = `‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢
‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${novelTitle}
‡πÅ‡∏ô‡∏ß: ${novelGenre}

‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (System Instruction):
1. ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô **‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
${styleInstruction}
3. ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢ ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏£‡∏¥‡πà‡∏ô‡∏ô‡∏≥ ‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
${lengthInstruction}
${nameInstruction}`;
        } else {
            initialPrompt = `‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢
‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${novelTitle}
‡πÅ‡∏ô‡∏ß: ${novelGenre}
‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß: ${totalChapters > 0 ? totalChapters + ' ‡∏ï‡∏≠‡∏ô' : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}

‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô: ${writingStyle === 'literary' ? '‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏ó‡∏û/‡∏ß‡∏£‡∏£‡∏ì‡∏Å‡∏£‡∏£‡∏°' : '‡∏†‡∏≤‡∏©‡∏≤‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô/‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢'}
‡∏¢‡∏∏‡∏Ñ‡∏™‡∏°‡∏±‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£: ${nameEra}

‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏´‡∏π‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏â‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢`;
        }

        addMessageToUI(initialPrompt, 'user');
        sendMessageToGemini(initialPrompt);
    }
    
    function updateChapterDisplay() {
        const statusDiv = document.getElementById('chapter-status');
        if (totalChapters > 0) {
            statusDiv.textContent = `‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${currentChapter} / ${totalChapters}`;
            if (currentChapter >= totalChapters) {
                document.getElementById('next-chapter-btn').textContent = "üèÅ ‡∏à‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á";
            } else {
                document.getElementById('next-chapter-btn').textContent = "‚è≠Ô∏è ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà";
            }
        } else {
            statusDiv.textContent = `‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${currentChapter}`;
        }
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function sendMessage() {
        const inputField = document.getElementById('user-input');
        const message = inputField.value.trim();

        if (message) {
            addMessageToUI(message, 'user');
            inputField.value = '';
            sendMessageToGemini(message);
        }
    }

    function addMessageToUI(text, sender) {
        const chatHistoryDiv = document.getElementById('chat-history');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
        
        if (sender === 'ai') {
            // Parse Markdown for AI responses
            messageDiv.innerHTML = marked.parse(text);
        } else {
            messageDiv.textContent = text;
        }
        
        chatHistoryDiv.appendChild(messageDiv);
        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
    }

    async function sendMessageToGemini(userMessage) {
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.style.display = 'block';

        // Update history for context
        // Note: For simple prompt generation in this proxy version, we might send the full history as text 
        // or let the backend handle context. 
        // However, the current backend implementation expects a simple "prompt" or "contents" structure.
        // Let's adjust the fetch to send to our local /api/chat endpoint.
        
        chatHistory.push({
            role: "user",
            parts: [{ text: userMessage }]
        });

        // Construct the full prompt context for the AI (since we are sending single prompt to backend proxy in this iteration)
        // Ideally backend should handle history, but to keep it simple with the new proxy:
        // We will send the last message + context if needed, OR send the full conversation structure if backend supports it.
        // My previous backend code: const { prompt } = req.body; -> parts: [{ text: prompt }]
        // So it only supports a single text block.
        // I need to serialize the chat history into that single text block OR update backend to accept history.
        // Let's serialize for now to match the backend change I just made.
        
        // BETTER APPROACH: The backend is a simple pass-through for "prompt". 
        // Let's format the history into a single string to send to backend, 
        // OR better yet, let's update backend to just pass through the body?
        // No, I implemented backend to take { prompt } and wrap it in `contents: [{ parts: [{ text: prompt }] }]`.
        // So I should send the LATEST message combined with context if I want to maintain context.
        // BUT, Gemini API supports `contents` array for history.
        // The backend I wrote:
        // body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        // This effectively resets context every time if I only send the new message.
        // THIS IS A BUG in my backend plan. I need to fix backend to accept full history or I fix frontend to merge history.
        // Merging history into one big string is easier for "quick fix".
        
        // Let's concat history for now.
        let fullPrompt = chatHistory.map(msg => `${msg.role === 'user' ? 'User' : 'Model'}: ${msg.parts[0].text}`).join('\n\n');

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: fullPrompt
                })
            });

            const data = await response.json();
            
            if (data.error) {
                console.error('Error:', data.error);
                addMessageToUI("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (data.error.message || JSON.stringify(data.error)), 'ai');
            } else {
                const aiResponse = data.candidates[0].content.parts[0].text;
                
                // Add AI response to history
                chatHistory.push({
                    role: "model",
                    parts: [{ text: aiResponse }]
                });

                addMessageToUI(aiResponse, 'ai');
            }
        } catch (error) {
            console.error('Fetch Error:', error);
            addMessageToUI("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠", 'ai');
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    function exportChat() {
        if (chatHistory.length === 0) {
            alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
            return;
        }

        let content = `‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${novelTitle}\n‡πÅ‡∏ô‡∏ß: ${novelGenre}\n\n------------------\n\n`;
        
        chatHistory.forEach(msg => {
            const role = msg.role === 'user' ? '‡∏Ñ‡∏∏‡∏ì' : 'AI';
            content += `[${role}]:\n${msg.parts[0].text}\n\n`;
        });

        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${novelTitle || 'novel'}_chat_history.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function resetChat() {
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà? ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")) {
            chatHistory = [];
            novelTitle = "";
            novelGenre = "";
            document.getElementById('chat-history').innerHTML = "";
            document.getElementById('novel-title').value = "";
            document.getElementById('novel-genre').value = "";
            document.getElementById('chat-section').style.display = 'none';
            document.getElementById('setup-section').style.display = 'flex';
        }
    }

    function continueStory() {
        const prompt = writingStyle === 'literary' 
            ? "‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢ (‡∏Ñ‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏©‡∏≤‡∏ß‡∏£‡∏£‡∏ì‡∏Å‡∏£‡∏£‡∏°)" 
            : "‡πÄ‡∏•‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô! ‡πÄ‡∏≠‡∏≤‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏™‡πå (‡∏Ñ‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô)";
        
        addMessageToUI("‚è© ‡πÅ‡∏ï‡πà‡∏á‡∏ï‡πà‡∏≠‡∏â‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°...", 'user');
        sendMessageToGemini(prompt);
    }

    function nextChapter() {
        currentChapter++;
        updateChapterDisplay();

        let prompt = "";
        if (totalChapters > 0 && currentChapter >= totalChapters) {
             prompt = `‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà **‡∏ï‡∏≠‡∏ô‡∏à‡∏ö (‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${currentChapter})** ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏Ç‡∏°‡∏ß‡∏î‡∏õ‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå`;
        } else {
             prompt = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô **‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${currentChapter}** ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô`;
        }

        addMessageToUI(totalChapters > 0 && currentChapter >= totalChapters ? "üèÅ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏≠‡∏ô‡∏à‡∏ö..." : `‚è≠Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${currentChapter}...`, 'user');
        sendMessageToGemini(prompt);
    }
</script>

</body>
</html>
